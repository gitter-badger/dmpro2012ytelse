\section{Control Module}

The control module is responsible for coordinating the activity of the
other parts of the image processor and for data transfer into and within
the image processor. A visual overview of the control module is given in
figure \ref{fig:control-module}.

\input{fig/fpga/control_module}

The control module decodes the state signal set by the AVR, and enables,
disables and resets components accordingly. It is responsible for
performing data transfers between the AVR and the program/data memories,
and for transferring data internally, between the SIMD node array, data
RAM and the VGA screen buffer.

The control module contains the CPU core that is used for the non-SIMD
instructions embedded in a program. This CPU core, henceforth referred
to as the \emph{control core}, is mainly concerned with loop control,
initiating data transfers between the SIMD node array and the data RAM,
and copying image data to the VGA controller.

\subsection{States}

The operation of the image processor is fully controlled by the SCU. The
SCU sets a state value that is used by the control module to select
which components of the image processor are active. This is indicated by
the red signals in figure \ref{fig:control-module}.

The states recognized by the image processor are listed in table
\ref{tab:states}.

\input{fig/fpga/states}

\subsection{Control Core}

A schematic overview of the control core is given in figure
\ref{fig:fpga-ctrl-core}. The core consist of a register bank of 21 bit
registers, an ALU and a connection to the data RAM. The word width of 21
bits was chosen to match the address width of the data RAM. This allows
the control core to do pointer arithmetic referring to arbitrary words
in the data RAM.

\input{fig/fpga/fpga_ctrl_core}

To send pixels to the VGA controller, two of the registers are dedicated
to contain an address and a pixel value, respectively. The contents of
these registers are constantly sent to the VGA controller. By
incrementing and loading RAM values into these registers, using the
control core's regular instruction set, the control core program can
upload images to the VGA screen buffer.

A third register is wired to the DMA controller, to enable 21 bit wide
DMA parameters to be set programmatically.

The control core runs instructions from the same instruction stream as
the SIMD nodes, and thus the control core and the SIMD array share a
common program counter. The leftmost bit in the instructions specifies
whether the instruction is a control core instruction or a SIMD
instruction.

The control core instruction set is specified in detail in appendix
\ref{app:control-inst}.

\subsection{DMA}
\subsection{Program Flow}
