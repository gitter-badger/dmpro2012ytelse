\section{SIMD nodes}

\ac{SIMD} nodes are the main processing cores of the image processor and are
responsible for carrying out data processing-instructions in paralell. They
share the same instruction set and executes the same instruction, hence
\acf{SIMD} and operates on an 8-bit word size, as most of the processor does.

Each \ac{SIMD} node is fully equipped with a register bank, an \ac{ALU}, message
passing with adjacent nodes and an instruction decoder for the \ac{SIMD} node
instruction set, explained in detail in subsequent section.

The schematic of a single \ac{SIMD} node is shown in figure
\ref{fig:fpga-simd-arch} details the entire datapath for the node. Different
parts of the instruction and other inputs and outputs to and from the node are
all labled with red lables. In this section we will reffer to this image when
explaining the different components.

\TODO{Fix signal labels in arhitecture image to differentiate between input, output and instruction}

\input{fig/fpga/fpga-simd-arch}

\subsection{Components}

\TODO{This pharagraph is kind of VHDL implementation specific. Should we keep it?}

In order to the keep the ammount of intermediate signals to a minimum, as well
as better reusability accross other parts of the processor, the \ac{SIMD} node
is nicely divided into separate, stand-alone, components which when linked
together makes up the datapath for the node.

\subsubsection{Instruction Decoder}

\TODO{List all the different OP-codes and their meaning.}

When an instructions is first recieved by a \ac{SIMD} node the first 5-bits
(enable, mask and opcode) are fed directly into the Instruction Decoder. The
decoder will then set up the correct control signals other components based on
the current state of the \ac{SIMD} node and instruction opcode.

\subsubsection{Communication}
The Communication component controlls outbound data from the \ac{SIMD} node to
adjacent \ac{SIMD} nodes in the grid array. It can either send data from 4
registers out on north-, south-, east- and west-bound links, forward incoming
links in an clockwise spiral according to \ref{fig:fpga-simd-datacom} or keep
the previously outgoing data. The latter is very important in order for
branching to work correctly; where some \ac{SIMD} nodes, depending on their
state, may store incoming data in one register and others \ac{SIMD} nodes in an
other register.

The clockwise spiral forwarding is an optimized way of distributing a 3x3 array
of source data to all the \ac{SIMD} nodes in the grid array using only 3-clock
cycles. \TODO{We made this one ourselves! note that down}

\subsubsection{Register Bank}
Each \ac{SIMD} node is equpped with $2^4 = 16$ general purpose registers. 14 of
which are available for general storage during acecution. The remaining 2 are
reserved for the special purpose registers {\tt \$zero} and {\tt \$state}.

\input{fig/fpga/simd-registers}

The register bank has specially designed with the four way data transfer in
mind. It supports reading, or writing, 4 registers at once or reading 2
registers and writing 1 register within one clockcycle.

\subsubsection{Arithmetic Logic Unit}

\TODO{List the 8 ALU functions some where with their binary prepresentation.}

The \ac{ALU} implemented is a very simple {\tt 8}-bit \ac{ALU} supporting only 8
instructions. The main reason for only implementing the most basic arithmetic
instruction was to save space in the instruction set, since all \ac{SIMD} node
instructions carries the 3-bit \ac{ALU} function at the end, and to reduce the
pysical size of the node.

\TODO{Add some supporting references.}

Upon investigating image processing algorithmes we found that many of these,
Median Filter and Salt and Pepper noice reduction, only need these 8 \ac{ALU}
operations in order to perform their work. Besides; more high level arithmetic,
such as multiply and divide, can be implemented using addition and subtraction.

\subsubsection{Source Data Register}
The source data register (S REG), is a special purpose register within the
\ac{SIMD} node which holds the next source data for the \ac{SIMD} node. It is
partly controlled by the \ac{SIMD} node instruction set and partly by a special
{\tt step} signal sent from the \ac{DMA}.

An important attribute of the S REG is its capability to receive data from the
left node and passing it along to node on the right when instructed by the {\tt
  step} signal. This allows for a simultaneous data transfer while the node is
otherwise busy processing.

\subsubsection{State Register}
In order to handle branches the \ac{SIMD} node must have some internal
state. The State Register is, as all other registers, 8-bit. The least
significant bit is the current state wich is sent out from the node and to the
Instruction Decoder unit within the \ac{SIMD} node.

The State Register can be written and read as any other register in the Register
Bank and the state can hence be shifted left or right in order to acheave nested
branches.

\subsection{DRAM and SRAM}

\TODO{Where to put this?}

\ac{DRAM} or \ac{SRAM} is not available from the \ac{SIMD} nodes.

\subsection{Instruction Set}

\input{fig/fpga/fpga-simd-datacom}

\subsection{Branching}
\CHECK{Should this be added to the appendix or something?}

Since all nodes run the same instructions, both parts of a branch must be
executed. Nodes are setting the {\tt state} to 1 in order to indicate that they
are executing within that part of the branch.

\input{fig/fpga/single-level-branching}

\subsubsection{Multilevel branching}
Since state register is 8 it is possible to have up-to 8 nested branches by
shifting the current state to the left and adding the new state to the
end. Below \TODO{Refer to table, not relative to where it is placed} are the
instructions for performing a multilevel-branch.

\input{fig/fpga/multilevel-branching}
\CHECK{Could any of these tables be figures instead?}
