\section{SIMD nodes}

\ac{SIMD} nodes are the main processing elements of the image processor and are
responsible for carrying out image processing instructions in parallel. They
share the same instruction set and executes them in parallel, hence
\acf{SIMD}.

Each \ac{SIMD} node is fully equipped with a register bank,
an \ac{ALU} and data exchange with adjacent nodes.
Everything inside the node is operated through the SIMD node
instruction set explained in \ref{subsection:}.

The schematic of a single \ac{SIMD} node is shown in Figure
\ref{fig:fpga-simd-arch}, and details the entire data-path for the
node. External inputs to the node are drawn on the left side. Data-buses are 
marked as blue lines while control signals are red dashed lines. In the 
following section we will refer to this image when explaining the different 
components.

\input{fig/fpga/fpga-simd-arch}

\subsection{Components}

In this section we briefly describe the different components, their purpose, and
how they together form the data-path for the node. All components has been thoroughly
thought out and design to suit the \ac{SIMD} nodes.  

\subsubsection{Instruction Decoder}
Whenever a new instruction is received by the \ac{SIMD} node it is immediately 
decoded by the instruction decoder. Based on the enable-bit, mask-bit and OP-code
of the instruction correct control signals are set up for the remaining components
throughout the node.

For a list of all \ac{SIMD} instructions, see Appendix \ref{apx:simd-instruction-set}.

\subsubsection{Communication}
The communication component controls outbound data to adjacent \ac{SIMD} nodes in 
the grid array; north, south, east and west. The communication component is fairly 
simple and can either send register data or forward inbound data according to the counterclockwise forwarding scheme described in \ref{sec:simd-com}.

\subsubsection{Register Bank}
Each \ac{SIMD} node is equipped with $2^4 = 16$ 8-bit general purpose registers, 14 of
which are available for general storage during execution. The remaining 2 are
reserved for the special purpose registers {\tt \$zero} and {\tt \$state}.

\input{fig/fpga/simd-registers}

The register bank has been specially designed to suit the four-way data transfer by
allowing 4 registers to be read, or written, at during one clock-cycle.

\subsubsection{ALU}
Each \ac{SIMD} node has an 8-bit simple ALU supporting 8 arithmetic instructions: 
addition ({\sc add}), subtraction ({\sc sub}), set less than ({\sc slt}), {\sc and}, 
{\sc or}, equality check ({\sc eq}), shift logical left ({\sc sll}) and shift logical 
right ({\sc slr}). 

The main reason for only implementing the most basic arithmetic instruction was to save
space in the instruction set since addition, subtract, equality and less then are 
supported by special hardware inside the FPGA. All \ac{SIMD} node instructions carries
a 3-bit \ac{ALU} function at the end.

Upon researching image processing algorithms well suited for parallel processing, we
found that most of then could be implemented using only these 8 \ac{ALU} operations. 
Image processing algorithms such as median filter, various blur filters, edge detection, 
color manipulation such as inversion and thresholding are fully feasible using. More high
level arithmetic, such as multiply and divide by constants, can be implemented
through a series of additions, subtractions and shifts.

\CHECK{Proof-read this section!}
\CHECK{Add reffernces?}
\CHECK{Talk about general programability?}

\subsubsection{Source Data Register}
The source data register, or just \ac{S REG} for short, is a special purpose
register within the \ac{SIMD} node. It is a communication unit, separate form
the node itself, and is used to push new and processed image data through the
array while the \ac{SIMD} node is otherwise busy  which holds the next source data for the \ac{SIMD} node. It is
partly controlled by the \ac{SIMD} node instruction set and partly by a special
{\tt step} signal sent from the \ac{DMA}. \TODO{Og her er det tredje gangen vi
  introduserer dette S registeret vårt. Vi må plassere det et sted, og kun nevne
  det andre steder.}

An important attribute of the S REG is its capability to receive data from the
left node and passing it along to node on the right when instructed by the {\tt
  step} signal. This allows for a simultaneous data transfer while the node is
otherwise busy processing.

\subsubsection{State Register}
In order to handle branches, the \ac{SIMD} node must have some internal
state. To add state, we introduce a new register called the State Register. The
state register is, as all the other registers, 8-bit. The least significant bit
is the current state which is sent out from the node and to the instruction
decoder unit within the \ac{SIMD} node.

The state register can be written and read as any other register in the register
bank and the state can hence be shifted left or right in order to achieve nested
branches.

\subsection{Communication}\label{sec:simd-com}

\input{fig/fpga/fpga-simd-datacom}

\subsubsection{Forwarding}
The clockwise spiral forwarding is an optimized way of distributing a 3$\times$3
array of source data to all the \ac{SIMD} nodes in the grid array using only 3
clock cycles, compared to ??? cycles when not using the clockwise
spiral.

\TODO{We made this one ourselves! note that down. Jahre vil at dette skal forklares bedre}

\subsection{Instructions}
Something about ideology...++


\subsubsection{Branching}
Since all nodes run the same instructions, both parts of a branch must be
executed. Nodes are setting the {\tt state} to 1 in order to indicate that they
are executing within that part of the branch. An example of single branching is
shown in Listing \ref{lst:single-branch}.

{\sc \color{green} LENA-assembly here (fixed)}

Since the state register is 8 bits, it is possible to have up to 8 nested
branches by shifting the current state left and adding the new state to the
end. Listing \ref{lst:multibranch} contains code which performs such a
multilevel branch.

{\sc \color{green} LENA-assembly here (fixed)}
