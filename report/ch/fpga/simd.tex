\section{SIMD nodes}

\ac{SIMD} nodes are the main processing cores of the image processor and are
responsible for carrying out data processing instructions in parallel. They
share the same instruction set and executes the same instruction, hence
\acf{SIMD}.

Each \ac{SIMD} node is fully equipped with a 8-bit register bank, an \ac{ALU} and data exchange with adjacent nodes. Everything are operated through the SIMD node instruction set explained in detail in subsequent sections.

The schematic of a single \ac{SIMD} node is shown in Figure
\ref{fig:fpga-simd-arch}, and details the entire data path for the
node. Different parts of the instruction and other inputs and outputs to and
from the node are all labeled with \CHECK{Again, color print}red labels. In this
section we will refer to this image when explaining the different components.

\input{fig/fpga/fpga-simd-arch}

\subsection{Components}

We wanted to keep the amount of intermediate signals to a minimum, as well as
give better reusability across other parts of the processor. Therefore the SIMD
nodes have been nicely divided into separate, stand-alone components which make
up the data path of a node when linked together.

\subsubsection{Instruction Decoder}

When an instruction is first received by a \ac{SIMD} node, the first 5 bits
(enable, mask and opcode) are fed directly into the Instruction Decoder. The
decoder will then set up the correct control signals other components based on
the current state of the \ac{SIMD} node and instruction opcode. For a list all
\ac{SIMD} instructions, see Appendix \ref{apx:simd-instruction-set}.

\subsubsection{Communication}
The communication component controls outbound data from the \ac{SIMD} node to
adjacent \ac{SIMD} nodes in the grid array. It can either send data from 4
registers out on north-, south-, east- and westbound links, forward incoming
links in a clockwise spiral as in Figure \ref{fig:fpga-simd-datacom}, or keep
the previously outgoing data. The latter is critical to ensure correctness when
branching. \ac{SIMD} nodes may store incoming data, depending on their
state. For instance, one group of \ac{SIMD} nodes may store incoming data in one
register, whereas other \ac{SIMD} nodes may place them in another register, or
perhaps not at all.

The clockwise spiral forwarding is an optimized way of distributing a 3$\times$3
array of source data to all the \ac{SIMD} nodes in the grid array using only 3
clock cycles, compared to ??? cycles when not using the clockwise
spiral. \TODO{We made this one ourselves! note that down. Jahre vil at dette
  skal forklares bedre}

\subsubsection{Register Bank}
Each \ac{SIMD} node is equipped with $2^4 = 16$ general purpose registers, 14 of
which are available for general storage during execution. The remaining 2 are
reserved for the special purpose registers {\tt \$zero} and {\tt \$state}.

\input{fig/fpga/simd-registers}

The register bank has been specially designed with the four-way data transfer in
mind. It supports reading or writing 4 registers at once, or reading 2
registers and writing 1 register within one clock cycle.

\subsubsection{Arithmetic Logic Unit}

The \ac{ALU} implemented is a very simple {\tt 8}-bit \ac{ALU} supporting only 8
instructions: addition ({\sc add}), subtraction ({\sc sub}), set less than ({\sc
  slt}), {\sc and}, {\sc or}, equality check ({\sc eq}), shift logical left
({\sc sll}) and shift logical right ({\sc slr}). The main reason for only
implementing the most basic arithmetic instruction was to save space in the
instruction set. All \ac{SIMD} node instructions carry the 3-bit \ac{ALU}
function at the end, which reduces the physical size of the node.

\TODO{Add some supporting references!!!}

Upon investigating image processing algorithms, we found that many of these need
only 8 \ac{ALU} operations in order to perform their work. As an example, Median
Filter, Salt and Pepper noise reduction, {\color{red} add more here}. More high
level arithmetic, such as multiply and divide by constants, can be implemented
through a series of additions, subtractions and shifts. \TODO{Jahre skriver: "2
  Er ikke mange. Hvilke andre har dere kikket på?"}

\subsubsection{Source Data Register}
The source data register (S REG), is a special purpose register within the
\ac{SIMD} node which holds the next source data for the \ac{SIMD} node. It is
partly controlled by the \ac{SIMD} node instruction set and partly by a special
{\tt step} signal sent from the \ac{DMA}.

An important attribute of the S REG is its capability to receive data from the
left node and passing it along to node on the right when instructed by the {\tt
  step} signal. This allows for a simultaneous data transfer while the node is
otherwise busy processing.

\subsubsection{State Register}
In order to handle branches, the \ac{SIMD} node must have some internal
state. To add state, we introduce a new register called the State Register. The
state register is, as all the other registers, 8-bit. The least significant bit
is the current state which is sent out from the node and to the instruction
decoder unit within the \ac{SIMD} node.

The state register can be written and read as any other register in the register
bank and the state can hence be shifted left or right in order to achieve nested
branches.

\input{fig/fpga/fpga-simd-datacom}
{\sc \color{red} Figur \ref{fig:fpga-simd-datacom} flyter i løse lufta. Plasser
  den et eller annet sted.}

\subsection{Branching}
Since all nodes run the same instructions, both parts of a branch must be
executed. Nodes are setting the {\tt state} to 1 in order to indicate that they
are executing within that part of the branch. An example of single branching is
shown in Listing \ref{lst:single-level-branching}.

\input{lst/fpga/single-level-branching}

Since the state register is 8 bits, it is possible to have up to 8 nested
branches by shifting the current state left and adding the new state to the
end. Listing \ref{lst:multilevel-branching} contains code which performs such a
multilevel branch.

\input{lst/fpga/multilevel-branching}
